<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Чат XGRAM</title>
<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/dark.css" id="theme-link">
</head>
<body>
<div class="header">
  <h1>Чат</h1>
  <div id="admin-btn" class="hidden" onclick="openAdmin()">⚡ Admin</div>
</div>

<div id="messages" style="height:400px; overflow:auto; border:1px solid #aaa;"></div>

<input id="msg" placeholder="Сообщение">
<button onclick="sendMsg()">Отправить</button>

<script type="module">
import { db } from './js/firebase.js';
import { ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const currentUser = localStorage.getItem("currentUser");
if (currentUser === "cell") document.getElementById("admin-btn").classList.remove("hidden");
window.openAdmin = () => window.location.href = "admin.html";

const urlParams = new URLSearchParams(window.location.search);
const chatId = urlParams.get("chat");
const chatRef = ref(db, 'chats/' + chatId + '/messages');

onValue(chatRef, (snapshot) => {
  const box = document.getElementById("messages");
  box.innerHTML = "";
  if (snapshot.exists()) {
    Object.values(snapshot.val()).forEach(msg => {
      box.innerHTML += `<p><b>${msg.sender}:</b> ${msg.text}</p>`;
    });
  }
  box.scrollTop = box.scrollHeight;
});

window.sendMsg = async () => {
  const text = document.getElementById("msg").value;
  if (!text) return;
  await push(chatRef, { sender: currentUser, text });
  document.getElementById("msg").value = "";
}
</script>
<script type="module" src="js/theme.js"></script>
</body>
</html>
